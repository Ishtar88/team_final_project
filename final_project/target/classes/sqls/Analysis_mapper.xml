<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jsr.project.analysis">

	<resultMap type="com.jsr.project.dtos.AnalysisDto" id="AnalysisDto">
		<result property="a_seq" column="A_SEQ" />
		<result property="a_code" column="A_CODE" />
		<result property="a_name" column="A_NAME" />
		<result property="a_img" column="A_IMG" />
		<result property="ma_seq" column="MA_SEQ" />
		<result property="id" column="ID" />
		<result property="ma_regDate" column="MA_REGDATE" />
	</resultMap>

	<resultMap type="com.jsr.project.dtos.SpendingDto" id="SpendingDto">
		<result property="p_regdate" column="P_REGDATE" />
		<result property="id" column="ID" />
		<result property="p_name" column="P_NAME" />
		<result property="p_money" column="P_MONEY" />
	</resultMap>

	<resultMap type="com.jsr.project.dtos.GoalDto" id="GoalDto">
		<result property="g_name" column="G_NAME" />
		<result property="g_money" column="G_MONEY" />
	</resultMap>

	<!-- 해당 월의 총 소비액 -->
	<select id="total_spending" parameterType="Map" resultType="Integer">
		SELECT SUM(P_MONEY) FROM SPENDING WHERE
		SUBSTR(TO_CHAR(P_REGDATE,'YYYY-MM'),1,7)=#{p_regdate} AND ID=#{id}
	</select>
	<!-- 해당 월의 총 투자액 -->
	<select id="invest_spending" parameterType="Map" resultType="Integer">
		SELECT NVL(SUM(P_MONEY),0) FROM SPENDING WHERE
		P_DETAIL='투자' AND
		SUBSTR(TO_CHAR(P_REGDATE,'YYYY-MM'),1,7)=#{p_regdate}
		AND ID=#{id}
	</select>
	<!-- 해당 월의 총 지출액 -->
	<select id="expense_spending" parameterType="Map" resultType="Integer">
		SELECT DISTINCT((SELECT SUM(P_MONEY) FROM SPENDING
		WHERE
		SUBSTR(TO_CHAR(P_REGDATE,'YYYY-MM'),1,7)=#{p_regdate} AND ID=#{id})-
		(SELECT NVL(SUM(P_MONEY),0) FROM SPENDING WHERE P_DETAIL='투자' AND
		SUBSTR(TO_CHAR(P_REGDATE,'YYYY-MM'),1,7)=#{p_regdate} AND ID=#{id}))AS
		DATA FROM SPENDING
	</select>
	<!-- 해당 월의 투자 비율 -->
	<select id="invest_ratio" parameterType="Map" resultType="Integer">
		SELECT
		DISTINCT (SELECT NVL(SUM(P_MONEY),0) FROM
		SPENDING WHERE
		P_DETAIL='투자'
		AND
		SUBSTR(TO_CHAR(P_REGDATE,'YYYY-MM'),1,7)=#{p_regdate}
		AND ID=#{id})
		/(SELECT SUM(P_MONEY) FROM SPENDING WHERE
		SUBSTR(TO_CHAR(P_REGDATE,'YYYY-MM'),1,7)=#{p_regdate} AND ID=#{id})AS
		DATA FROM SPENDING
	</select>
	<!-- 해당 월의 지출 비율 -->
	<select id="expense_ratio" parameterType="Map" resultType="Integer">
		SELECT DISTINCT(SELECT DISTINCT((SELECT SUM(P_MONEY)
		FROM SPENDING
		WHERE
		SUBSTR(TO_CHAR(P_REGDATE,'YYYY-MM'),1,7)=#{p_regdate}
		AND
		ID=#{id})-
		(SELECT NVL(SUM(P_MONEY),0) FROM SPENDING WHERE
		P_DETAIL='투자' AND
		SUBSTR(TO_CHAR(P_REGDATE,'YYYY-MM'),1,7)=#{p_regdate}
		AND
		ID=#{id}))FROM
		SPENDING)
		/(SELECT SUM(P_MONEY) FROM SPENDING WHERE
		SUBSTR(TO_CHAR(P_REGDATE,'YYYY-MM'),1,7)=#{p_regdate} AND ID=#{id})AS
		DATA FROM SPENDING
	</select>

	<!-- 총예산 -->
	<select id="total_goal" parameterType="Map" resultType="Integer">
		SELECT
		SUM(G_MONEY)AS G_MONEY FROM GOAL WHERE ID=#{id}
	</select>

	<!-- 총지출액 -->
	<select id="total_expense" parameterType="Map" resultType="Integer">
		SELECT SUM(P_MONEY) FROM SPENDING WHERE
		SUBSTR(TO_CHAR(P_REGDATE,'YYYY-MM'),1,7)=#{p_regdate} AND ID=#{id}
	</select>

	<!-- 카테고리별 예산 -->
	<select id="category_goal" parameterType="Map" resultMap="GoalDto">
		SELECT
		G_NAME,SUM(G_MONEY)AS G_MONEY FROM (SELECT
		ID,G_NAME,G_MONEY FROM GOAL
		WHERE
		ID=#{id}) GROUP BY G_NAME
	</select>

	<!-- 카테고리별 지출 -->
	<select id="category_expense" parameterType="Map" resultMap="SpendingDto">
		SELECT P_NAME,SUM(P_MONEY)AS P_MONEY FROM (SELECT
		ID,P_NAME,P_MONEY
		FROM SPENDING
		WHERE ID=#{id} AND
		SUBSTR(TO_CHAR(P_REGDATE,'YYYY-MM'),1,7)=#{p_regdate})
		GROUP BY P_NAME
	</select>

	<!-- 카테고리별 목표 달성률 -->



	<!--          -->
	<!-- 전병훈 작업 -->
	<!--          -->

	<!-- 투자 비율 조회 -->
	<select id="acountTotalRate" parameterType="AcountPatternDto" resultType="AcountPatternDto">
		SELECT DISTINCT SUM(ST_MONEY*ST_COUNT) OVER(PARTITION BY ID) AS AC_MONEY,ID,(SELECT 'STOCK' FROM DUAL) AS NAME FROM (SELECT ST_MONEY,ID,ST_COUNT FROM STOCK WHERE ID=#{id} AND ST_SELLABLE='N')
		UNION
		SELECT DISTINCT SUM(F_ADD) OVER(PARTITION BY ID) AS AC_MONEY,ID,(SELECT 'FUND' FROM DUAL) AS NAME FROM (SELECT F_ADD,ID,F_ENDABLE FROM FUND WHERE ID=#{id} AND F_ENDABLE='N')
		UNION
		SELECT DISTINCT SUM(S_ADD) OVER(PARTITION BY ID) AS AC_MONEY,ID,(SELECT 'SAVE' FROM DUAL) AS NAME FROM (SELECT S_ADD,ID,S_ENDABLE FROM SAVE WHERE ID=#{id} AND S_ENDABLE='N')
		UNION
		SELECT (ST_SUM+F_SUM+S_SUM) AS MONEY,SF.ID AS ID,(SELECT 'TOTAL' FROM DUAL) AS NAME
						FROM (SELECT DISTINCT SUM(ST_SUM) OVER(PARTITION BY ID) AS ST_SUM,ID FROM (SELECT ST_COUNT*ST_ADD AS ST_SUM, ID,ST_COUNT,ST_MONEY,ST_SEQ FROM STOCK WHERE ID=#{id})) ST 
							  JOIN (SELECT F_SUM,S_SUM,F.ID FROM (SELECT DISTINCT SUM(F_ADD) OVER(PARTITION BY ID) AS F_SUM,ID FROM FUND WHERE ID=#{id}) F JOIN (SELECT DISTINCT SUM(S_ADD) OVER(PARTITION BY ID) AS S_SUM,ID FROM SAVE WHERE ID=#{id}) S
							  ON F.ID=S.ID) SF 
						ON SF.ID=ST.ID
	</select>
	
	<!-- 투자 분류 내역 조회 -->
	<select id="acountTotalDetailAjax" parameterType="AcountPatternDto" resultType="AcountPatternDto">
		SELECT MONEY,ID,DETAIL,NAME,RATE,RE
		FROM (SELECT (ST_MONEY*ST_COUNT) AS MONEY,((ST_MONEY*ST_COUNT)/(SELECT (ST_SUM+F_SUM+S_SUM) AS AC_MONEY
																			FROM (SELECT DISTINCT SUM(ST_SUM) OVER(PARTITION BY ID) AS ST_SUM,ID FROM (SELECT ST_COUNT*ST_ADD AS ST_SUM, ID,ST_COUNT,ST_MONEY,ST_SEQ FROM STOCK WHERE ID=#{id})) ST 
																				  JOIN (SELECT F_SUM,S_SUM,F.ID FROM (SELECT DISTINCT SUM(F_ADD) OVER(PARTITION BY ID) AS F_SUM,ID FROM FUND WHERE ID=#{id}) F JOIN (SELECT DISTINCT SUM(S_ADD) OVER(PARTITION BY ID) AS S_SUM,ID FROM SAVE WHERE ID=#{id}) S
																				  ON F.ID=S.ID) SF 
																			ON SF.ID=ST.ID)) AS RATE,(1-(ST_MONEY/ST_ADD)) AS RE
					,ID,ST_NAME AS DETAIL,(SELECT 'STOCK' FROM DUAL) AS NAME FROM STOCK WHERE ID=#{id} AND ST_SELLABLE='N'
				UNION
				SELECT S_ADD AS MONEY,(S_ADD/(SELECT (ST_SUM+F_SUM+S_SUM) AS AC_MONEY
										    	FROM (SELECT DISTINCT SUM(ST_SUM) OVER(PARTITION BY ID) AS ST_SUM,ID FROM (SELECT ST_COUNT*ST_ADD AS ST_SUM, ID,ST_COUNT,ST_MONEY,ST_SEQ FROM STOCK WHERE ID=#{id})) ST 
										        JOIN (SELECT F_SUM,S_SUM,F.ID FROM (SELECT DISTINCT SUM(F_ADD) OVER(PARTITION BY ID) AS F_SUM,ID FROM FUND WHERE ID=#{id}) F JOIN (SELECT DISTINCT SUM(S_ADD) OVER(PARTITION BY ID) AS S_SUM,ID FROM SAVE WHERE ID=#{id}) S
													  ON F.ID=S.ID) SF 
												ON SF.ID=ST.ID)) AS RATE,S_TAX AS RE
				,ID,S_NAME AS DETAIL,(SELECT 'SAVE' FROM DUAL) AS NAME FROM SAVE WHERE ID=#{id} AND S_ENDABLE='N'
				UNION
				SELECT F_ADD AS MONEY,(F_ADD/(SELECT (ST_SUM+F_SUM+S_SUM) AS AC_MONEY
												FROM (SELECT DISTINCT SUM(ST_SUM) OVER(PARTITION BY ID) AS ST_SUM,ID FROM (SELECT ST_COUNT*ST_ADD AS ST_SUM, ID,ST_COUNT,ST_MONEY,ST_SEQ FROM STOCK WHERE ID=#{id})) ST 
											    JOIN (SELECT F_SUM,S_SUM,F.ID FROM (SELECT DISTINCT SUM(F_ADD) OVER(PARTITION BY ID) AS F_SUM,ID FROM FUND WHERE ID=#{id}) F JOIN (SELECT DISTINCT SUM(S_ADD) OVER(PARTITION BY ID) AS S_SUM,ID FROM SAVE WHERE ID=#{id}) S
													  ON F.ID=S.ID) SF 
												ON SF.ID=ST.ID)) AS RATE,(1-(F_MONEY/F_ADD)) AS RE
				,ID,F_NAME AS DETAIL,(SELECT 'FUND' FROM DUAL) AS NAME FROM FUND WHERE ID=#{id} AND F_ENDABLE='N' ORDER BY MONEY DESC) 
		ORDER BY NAME DESC
	</select>
	
	<!-- 투자 금액 top5 조회 -->
	<select id="acountMoneyTop" parameterType="AcountPatternDto" resultType="AcountPatternDto">
		<![CDATA[
			SELECT RN,MONEY,ID,DETAIL,NAME
			FROM (SELECT ROWNUM AS RN,MONEY,ID,DETAIL,NAME FROM (SELECT (ST_MONEY*ST_COUNT) AS MONEY,ID,ST_NAME AS DETAIL,(SELECT 'STOCK' FROM DUAL) AS NAME FROM STOCK WHERE ID=#{id} AND ST_SELLABLE='N'
							UNION
							SELECT S_ADD AS MONEY,ID,S_NAME AS DETAIL,(SELECT 'SAVE' FROM DUAL) AS NAME FROM SAVE WHERE ID=#{id} AND S_ENDABLE='N'
							UNION
							SELECT F_ADD AS MONEY,ID,F_NAME AS DETAIL,(SELECT 'FUND' FROM DUAL) AS NAME FROM FUND WHERE ID=#{id} AND F_ENDABLE='N' ORDER BY MONEY DESC) ORDER BY MONEY DESC) 
			WHERE ROWNUM<=5
		]]>
	</select>
	
	<!-- 기간별 수익 차트 조회 -->
	<select id="saveDateChartAjax" parameterType="AcountPatternDto" resultType="AcountPatternDto">
		
	</select>
	

</mapper>